#!/usr/bin/env python3

import re
import subprocess
from datetime import datetime

result = subprocess.run(['top', '-l', '1'], capture_output=True)

if result.returncode != 0:
    raise RuntimeError

out = result.stdout.split(b'\n')


class Parser:
    regex = ()

    @classmethod
    def parse(cls, text):
        res = {}
        for name, r in cls.regex:
            m = re.search(r, text)
            if m:
                res[name] = m.groups()[0]
        return res


class ProcessesParser(Parser):
    regex = (
        ('total', r'(\d+) total'),
        ('running', r'(\d+) running'),
        ('sleeping', r'(\d+) sleeping'),
        ('stuck', r'(\d+) stuck'),
        ('threads', r'(\d+) threads'),
    )


class ProcessCount:
    def __init__(self, total=0, running=0, sleeping=0, stuck=0, threads=0):
        self.total = int(total)
        self.running = int(running)
        self.sleeping = int(sleeping)
        self.stuck = int(stuck)
        self.threads = int(threads)

    @classmethod
    def from_text(cls, text: str):
        return cls(**ProcessesParser.parse(text))


class LoadAvgParser(Parser):
    regex = (
        ('a', r'Load Avg: ([^,]+), '),
        ('b', r'Load Avg: [^,]+, ([^,]+), '),
        ('c', r'Load Avg: [^,]+, [^,]+, ([^,]+) '),
    )


class LoadAvg:
    def __init__(self, *avgs):
        self.avgs = [float(i) for i in avgs]

    @classmethod
    def from_text(cls, text):
        return cls(*LoadAvgParser.parse(text).values())


header = out[11].decode()
offsets = [0]
for i, _ in enumerate(header):
    if i == 0:
        continue
    if header[i] != ' ' and header[i-1] == ' ':
        offsets.append(i)
table = []
for l in out[12:]:
    line = l.decode()
    row = []
    for i, _ in enumerate(offsets):
        if i == 0:
            continue
        row.append(line[offsets[i-1]: offsets[i]].strip())
    table.append(row)


p = ProcessCount.from_text(out[0].decode())
la = LoadAvg.from_text(out[2].decode())

print(f'Load:{la.avgs}', end='')
print(' | ', end='')
print(datetime.now().strftime('%m/%d(%a) %H:%M'))
